<!DOCTYPE html>
<html layout:decorate="~{layout/main-layout}">
    <head>
        <title>Zarządzanie użytkownikami</title>
        <th:block layout:fragment="page-styles">
            <link rel="stylesheet" th:href="@{/css/admin/admin-users.css}" href="../../static/css/admin/admin-users.css">
        </th:block>
    </head>
    <body>
        <div layout:fragment="content">
            
            <!-- <nav class="breadcrumb">
                <a href="/dashboard" class="breadcrumb-item">
                    <i class="fas fa-home"></i> Strona główna
                </a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-item active">Panel administratora</span>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-item active">Lista użytkowników</span>
            </nav> -->
            
            <div class="admin-header">
                <div>
                    <h1>Użytkownicy</h1>
                    <p>Lista wszystkich zarejestrowanych osób w systemie</p>
                </div>
            </div>

            <div class="users-table-wrapper">
                <div class="table-controls">
                    
                    <div class="filters-section">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="Wyszukaj użytkownika po imieniu, nazwisku lub adresie e-mail" title="Wyszukaj użytkownika po imieniu, nazwisku lub adresie e-mail">
                        </div>
                        <div class="filter-group">
                            <label for="roleFilter"><i class="fas fa-user-tag"></i> Rola:</label>
                            <select id="roleFilter">
                                <option value="">Wszystkie</option>
                                <option value="ADMIN">Admin</option>
                                <option value="STAROSTA">Starosta</option>
                                <option value="STUDENT">Student</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="groupFilter"><i class="fas fa-users"></i> Kierunek:</label>
                            <select id="groupFilter">
                                <option value="">Wszystkie</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="yearFilter"><i class="fas fa-graduation-cap"></i> Rok:</label>
                            <select id="yearFilter">
                                <option value="">Wszystkie</option>
                                <option value="1">I</option>
                                <option value="2">II</option>
                                <option value="3">III</option>
                                <option value="4">IV</option>
                                <option value="5">V</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="statusFilter"><i class="fas fa-toggle-on"></i> Status:</label>
                            <select id="statusFilter">
                                <option value="">Wszystkie</option>
                                <option value="true">Aktywne</option>
                                <option value="false">Nieaktywne</option>
                            </select>
                        </div>

                        <button class="btn-reset" id="resetFilters">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                        
                        <button class="btn-export" id="exportCsvBtn" title="Eksportuj widocznych użytkowników do pliku CSV">
                            <i class="fas fa-file-csv"></i> Eksportuj CSV
                        </button>
                    </div>
                    
                    <div class="results-info">
                        <span id="resultsCount">0</span> <span id="resultsText">użytkowników</span>
                    </div>
                </div>
                
                <!-- Kontrolki paginacji - góra -->
                <div class="pagination-controls" id="paginationTop">
                    <div class="pagination-info">
                        Strona <span id="currentPageTop">1</span> z <span id="totalPagesTop">1</span>
                    </div>
                    <div class="pagination-buttons">
                        <button class="pagination-btn" id="prevPageTop" disabled><i class="fas fa-chevron-left"></i> Poprzednia</button>
                        <button class="pagination-btn" id="nextPageTop">Następna <i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="pagination-size">
                        <label for="pageSizeTop">Na stronie:</label>
                        <select id="pageSizeTop">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="all">Wszystkie</option>
                        </select>
                    </div>
                </div>
                
                <!-- Kontener na tabelę z osobnym przewijaniem -->
                <div class="table-scroll-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-column="0" data-type="number">
                                    ID <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="1" data-type="text">
                                    Imię i Nazwisko <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="2" data-type="text">
                                    Email <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="3" data-type="text">
                                    Rola <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="4" data-type="text">
                                    Kierunek <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="5" data-type="number">
                                    Rok <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="6" data-type="number">
                                    NrAlbumu <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="user : ${users}" 
                                th:data-year="${user.yearOfStudy}" 
                                th:data-status="${user.isActivated}">

                                <td th:text="${user.id}">1</td>

                                <td>
                                    <div class="user-cell">
                                        <div class="user-avatar-icon">
                                            <i class="fas fa-user"></i>
                                            <span class="status-dot" 
                                                  th:classappend="${user.isActivated} ? 'status-active' : 'status-inactive'"
                                                  th:title="${user.isActivated} ? 'Konto aktywne' : 'Konto nieaktywne'">
                                            </span>
                                        </div>
                                        <span th:text="${user.firstName} + ' ' + ${user.lastName}"> </span>
                                    </div>
                                </td>

                                <td th:text="${user.email}"> </td>

                                <td>
                                    <span class="badge" th:classappend="${user.role == 'ADMIN'} ? 'badge-admin' : (${user.role == 'STAROSTA'} ? 'badge-starosta' : 'badge-student')" th:text="${user.role}"> </span>
                                </td>

                                <td>
                                    <span th:if="${user.groupName != null}" th:text="${user.groupName}"></span>
                                    <i th:if="${user.groupName == null}">Nie przypisano kierunku</i>
                                </td>
                                
                                <td th:text="${user.yearOfStudy != null} ? ${user.yearOfStudy} : '-'"> </td>
                                
                                <td th:text="${user.nrAlbumu != null} ? ${user.nrAlbumu} : '-'"> </td>

                                <td>
                                    <button class="action-btn btn-edit" title="Edytuj"
                                            th:if="${user.role != 'ADMIN'}" 
                                            th:data-email="${user.email}"
                                            th:data-firstname="${user.firstName}"
                                            th:data-lastname="${user.lastName}"
                                            th:data-role="${user.role}"
                                            th:data-group="${user.groupName != null ? user.groupName : ''}"
                                            onclick="openEditModal(this)">
                                        <i class="fas fa-edit"></i>
                                    </button>

                                    <button class="action-btn btn-delete" title="Usuń" 
                                            th:if="${user.role != 'ADMIN'}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    
                                    <span th:if="${user.role == 'ADMIN'}" class="admin-protected-icon">
                                        <i class="fas fa-lock" title="Konto chronione"></i>
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                            <tr th:if="${users.empty}">
                                <td colspan="7" class="empty-state-cell">
                                    <div class="empty-state">
                                        <i class="fas fa-users"></i>
                                        <h3>Brak użytkowników</h3>
                                        <p>Nie znaleziono żadnych użytkowników spełniających podane kryteria.</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="editUserModal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edycja użytkownika</h3>
                        <button class="close-btn" onclick="closeEditModal()">&times;</button>
                    </div>
                    
                    <form id="editUserForm">
                        <input type="hidden" id="editEmail">

                        <div class="modal-body">
                            <div class="user-summary">
                                <div class="avatar-small">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <h4 id="editUserName"> </h4>
                                    <span id="editUserEmailDisplay" class="edit-user-email"> </span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="editRole">Rola</label>
                                <select id="editRole" class="form-control">
                                    <option value="STUDENT">Student</option>
                                    <option value="STAROSTA">Starosta</option>
                                    <option value="ADMIN" disabled>Administrator</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="editGroup">Przypisz do kierunku</label>
                                <select id="editGroup" class="form-control">
                                    <option value="">Nie przypisano do kierunku</option>
                                    <!-- grupy będą ładowane dynamicznie przez JavaScript -->
                                </select>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-tertiary" onclick="closeEditModal()">Anuluj</button>
                            <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal eksportu CSV -->
            <div id="exportModal" class="modal-overlay">
                <div class="modal-content export-modal">
                    <div class="modal-header">
                        <h3><i class="fas fa-file-csv"></i> Eksport do CSV</h3>
                        <button class="close-btn" onclick="closeExportModal()">&times;</button>
                    </div>
                    
                    <div class="modal-body">
                        <div class="export-data-summary" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-step); border-radius: 6px; border-left: 4px solid var(--color-primary);">
                            <h4 style="margin: 0; font-size: 0.95rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-info-circle"></i> Eksport danych
                            </h4>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--text-secondary);">
                                Zostanie wyeksportowanych <strong id="exportCount">0</strong> użytkowników (zgodnie z aktywnymi filtrami).
                            </p>
                        </div>
                        
                        <div class="export-section">
                            <h4><i class="fas fa-columns"></i> Kolumny do eksportu</h4>
                            <div class="export-columns">
                                <label class="checkbox-option">
                                    <input type="checkbox" id="exportId" checked>
                                    <span>ID</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" id="exportName" checked>
                                    <span>Imię i Nazwisko</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" id="exportEmail" checked>
                                    <span>Email</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" id="exportAlbum" checked>
                                    <span>Nr Albumu</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" id="exportRole" checked>
                                    <span>Rola</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" id="exportGroup" checked>
                                    <span>Kierunek</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" id="exportYear" checked>
                                    <span>Rok</span>
                                </label>
                            </div>
                            <div class="select-all-row">
                                <button type="button" class="btn-link" onclick="toggleAllColumns(true)">Zaznacz wszystkie</button>
                                <span>|</span>
                                <button type="button" class="btn-link" onclick="toggleAllColumns(false)">Odznacz wszystkie</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-tertiary" onclick="closeExportModal()">Anuluj</button>
                        <button type="button" class="btn btn-export" onclick="performExport()">
                            <i class="fas fa-download"></i> Pobierz CSV
                        </button>
                    </div>
                </div>
            </div>
        </div> 

        <th:block layout:fragment="page-scripts">
            <script th:src="@{/js/admin/admin-users.js}"></script>
        </th:block>

    </body>
</html>